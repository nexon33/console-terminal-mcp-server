<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Terminal Window</title>
  <link rel="stylesheet" href="node_modules/@xterm/xterm/css/xterm.css" />
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #1e1e1e;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    #terminal-container {
      width: 100%;
      height: calc(100% - 25px);
      padding: 10px;
      box-sizing: border-box;
    }

    .xterm {
      padding: 5px;
    }

    .statusbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 25px;
      background-color: #333;
      color: white;
      padding: 0 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
    }

    .action-btn { /* New style for general action buttons */
     background-color: #4CAF50; /* Green */
     color: white;
     border: none;
     padding: 4px 8px;
     cursor: pointer;
     border-radius: 3px;
     transition: background-color 0.2s;
     margin-left: 10px; /* Add some margin */
   }

   .action-btn:hover {
     background-color: #45a049;
   }

   .action-btn:disabled {
     background-color: #666;
     cursor: not-allowed;
   }

    .cancel-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
      transition: background-color 0.2s;
    }

    .cancel-btn:hover {
      background-color: #d32f2f;
    }

    .cancel-btn:disabled {
      background-color: #666;
      cursor: not-allowed;
    }

    .error-message {
      color: #f44336;
      padding: 10px;
      margin: 10px;
      background-color: rgba(244, 67, 54, 0.1);
      border-radius: 4px;
      display: none;
    }
  </style>
</head>

<body>
  <div id="terminal-container"></div>
  <div id="error-message" class="error-message"></div>
  <div class="statusbar">
    <span id="session-info">Terminal Session</span>
    <div>
       <button id="send-output-btn" class="action-btn">Unblock MCP request</button>
       <!-- Existing cancel button can be added here if needed, or styled as action-btn with different color -->
    </div>
  </div>

  <script src="node_modules/@xterm/xterm/lib/xterm.js"></script>
  <script src="node_modules/@xterm/addon-fit/lib/addon-fit.js"></script>
  <script>
    // Terminal session ID
    let sessionId = null;
    let isProcessRunning = true;

    // Initialize xterm.js
    const term = new Terminal({
      cursorBlink: true,
      fontFamily: 'Menlo, Monaco, "Courier New", monospace',
      fontSize: 14,
      theme: {
        background: '#1e1e1e',
        foreground: '#f0f0f0'
      }
    });

    // Initialize fit addon
    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);

    // Open terminal
    term.open(document.getElementById('terminal-container'));
    fitAddon.fit();
    window.addEventListener('resize', () => {
      fitAddon.fit();

      // Send new dimensions to main process
      if (sessionId) {
        const dimensions = term.getDimensions();
        window.ipcRenderer.send('terminal-resize', {
          sessionId: sessionId,
          cols: dimensions.cols,
          rows: dimensions.rows
        });
      }
    });
    // Resize terminal on window resize
    window.addEventListener('resize', () => {
      fitAddon.fit();
    });

    // Handle input from user
    term.onData(data => {
      if (isProcessRunning && sessionId) {
        window.ipcRenderer.send('terminal-input', { sessionId, input: data });
      }
    });

    // Show error message
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    // Receive session ID from main process
    window.ipcRenderer.on('session-id', (event, id) => {
      sessionId = id;
      document.getElementById('session-info').textContent = `Session: ${id}`;
    });

    // Receive terminal output from main process
    window.ipcRenderer.on('terminal-output', (event, data) => {
      term.write(data);
    });

    // Handle terminal exit
    window.ipcRenderer.on('terminal-exit', (event, exitCode) => {
      isProcessRunning = false;
      term.write(`\r\n\nProcess exited with code ${exitCode}\r\n`);
      document.getElementById('session-info').textContent = `Session: ${sessionId} (Completed - Exit Code: ${exitCode})`;
    });

    // Handle terminal errors
    window.ipcRenderer.on('terminal-error', (event, error) => {
      showError('Terminal error: ' + error);
    });

    // Handle "Send Current Output" button click
    const sendOutputBtn = document.getElementById('send-output-btn');

    if (sendOutputBtn) {
      sendOutputBtn.addEventListener('click', () => {
        if (!sessionId) {
          showError("Session not initialized. Cannot send output.");
          return;
        }
        if (!isProcessRunning) {
           // Optionally disable the button or show a message if process isn't running
           // For now, we allow sending output even if the process has exited,
           // as the buffer might still contain useful information.
        }

        const buffer = term.buffer.active;
        let output = '';
        for (let i = 0; i < buffer.length; i++) {
          const line = buffer.getLine(i);
          if (line) {
            output += line.translateToString(true) + '\r\n'; // true to include wide chars, keep \r\n for lines
          }
        }

        if (output.length > 0) {
          window.ipcRenderer.send('terminal-send-current-output', { sessionId, output });
          // Optionally, provide feedback to the user that output was sent
          // term.write("\r\n\x1b[32m[Current output sent to Claude]\x1b[0m\r\n");
        } else {
          // term.write("\r\n\x1b[33m[No output to send]\x1b[0m\r\n");
        }
      });
    } else {
       console.error("Send Output button not found");
    }

  </script>
</body>

</html>